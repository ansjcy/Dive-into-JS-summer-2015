<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Force</title>
    <script src = "vector.js"></script>
    <script src = "miserables.js"></script>
    <style>
        html, body, svg{
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <svg viewBox="0, 0, 400, 400">
        <path id = "links" fill = "none" stroke="gray"></path>
    </svg>
</body>
<script>
    var points = [];
    //var linkPath = [];
    for(var i = 0; i < 77; i++){
        var point = {};
        point.name = miserables.nodes[i].name;
        point.color = 'hsl(' + (360 * (miserables.nodes[i].group + 1) / 11) + ', 100%, 60%)';
        point.id = i;
        points.push(point);
    }
    
    //var svg = document.getElementsByTagNameNS("svg");
    var svg = document.querySelector('svg');
    var balance = 300;      //length with no move
    var k = 0.05; //try!!
    var vector = window.vector;
    function random(min, max){
        return Math.round(min + (max - min)  * Math.random());
    }


    points.forEach(function(points){
        var circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
        var x = random(0, 400);
        var y = random(0, 400);
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('r', 5);
        circle.setAttribute('fill', points.color);

        svg.appendChild(circle);

        points.circle = circle;
        points.s = new vector(x, y);    //displacement
        points.v = new vector();        //velocity
        points.a = new vector();        //acceleration
    });

    var lastFrameTime = +new Date();

    function update(){
        var frameTime = +new Date();
        var t = frameTime - lastFrameTime;

        t /= 200;     //try!!

        points.forEach(function(pa){
            var f = new vector();
            points.forEach(function (pb) {
                if(pa == pb)
                    return;
                var x = vector.fromPoints(pa.s, pb.s);
                var delta = x.length() - balance;

                f = f.add(x.normalize(delta * k));
            });
            pa.a = f;
            pa.v = pa.v.add(pa.a.mul(t).mul(0.6)); //momentum smaller and smaller
            pa.s = pa.s.add(pa.v.mul(t));

            pa.circle.setAttribute('cx', pa.s.x);
            pa.circle.setAttribute('cy', pa.s.y);
        });

        var linkPath = [];
        for(var i = 0; i < 254; i++){
            linkPath = linkPath.concat([
                'M', points[miserables.links[i].source].s.x, points[miserables.links[i].source].s.y,
                'L', points[miserables.links[i].target].s.x, points[miserables.links[i].target].s.y
            ])

        }

        document.getElementById('links').setAttribute('d', linkPath.join(' '));
        lastFrameTime = frameTime;
        window.requestAnimationFrame(update);
    }
    window.requestAnimationFrame(update);
</script>
</html>